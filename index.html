
        <!DOCTYPE html>
        <html>
        <head>
            <title>Travian Bot Dashboard</title>
            <style>
                body { font-family: 'Segoe UI', sans-serif; background-color: #f4f4f4; color: #333; margin: 0; padding: 20px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
                h1, h2, h3 { color: #5a3e2b; margin-top: 0; }
                .controls { background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; flex-shrink: 0; }
                #main-container { display: flex; gap: 20px; flex-grow: 1; min-height: 0; }
                #left-panel, #right-panel { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
                #left-panel { flex: 1; }
                #right-panel { flex: 2; }
                #log-container { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; margin-top: 20px;}
                #log { flex-grow: 1; overflow-y: scroll; border: 1px solid #ddd; padding: 10px; background: #fafafa; font-family: monospace; font-size: 12px; }
                button { padding: 10px 15px; margin: 5px; border: none; border-radius: 4px; color: white; cursor: pointer; background-color: #777; }
                button:hover { opacity: 0.9; }
                #startBtn { background-color: #4CAF50; }
                #stopBtn { background-color: #f44336; }
                input, select { box-sizing: border-box; width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
                #village-list, #account-list { overflow-y: auto; }
                .village-list-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
                .village-list-item:hover { background-color: #f0f0f0; }
                .village-list-item.active { background-color: #e8e0d6; font-weight: bold; }
                table { width: 100%; border-collapse: collapse; margin-top: 10px;}
                th, td { text-align: left; padding: 8px; border-bottom: 1px solid #ddd;}
                th { background-color: #f2f2f2; }
            </style>
        </head>
        <body>
            <div class="controls"><h1>Travian Bot Dashboard</h1><button id="startBtn">Start Bot</button><button id="stopBtn">Stop Bot</button></div>
            <div id="main-container">
                <div id="left-panel">
                    <h2>Accounts</h2><div id="account-list"></div><form id="add-account-form"><h3>Add New Account</h3><input type="text" id="username" placeholder="Username" required><input type="password" id="password" placeholder="Password" required><input type="text" id="server_url" placeholder="Server URL" required><button type="submit">Add Account</button></form>
                    <hr><h2>Villages</h2><div id="village-list"></div>
                </div>
                <div id="right-panel">
                    <div id="village-details"><h2>Select a village to see details</h2></div>
                    <div id="log-container"><h2>Live Log</h2><div id="log"><p>Welcome! Add an account and click "Start Bot" to begin.</p></div></div>
                </div>
            </div>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
            <script>
                const socket = io();
                let FULL_STATE = {};
                let GID_NAMES = {1:"Woodcutter",2:"Clay Pit",3:"Iron Mine",4:"Cropland",5:"Sawmill",6:"Brickyard",7:"Iron Foundry",8:"Grain Mill",9:"Bakery",10:"Warehouse",11:"Granary",15:"Main Building",16:"Rally Point",17:"Marketplace",19:"Barracks",20:"Stable",21:"Workshop",22:"Academy",24:"Town Hall",25:"Residence",26:"Palace",42:"Tournament Square"};
                let selectedVillageId = null;

                socket.on('connect', () => console.log('Websocket connected!'));
                socket.on('log_message', msg => {
                    const log = document.getElementById('log');
                    log.innerHTML += msg.data.replace(/</g, "&lt;").replace(/>/g, "&gt;") + '<br>';
                    log.scrollTop = log.scrollHeight;
                });
                socket.on('state_update', newState => {
                    FULL_STATE = newState;
                    console.log("Received state update:", FULL_STATE);
                    renderAccountsAndVillages();
                    if(selectedVillageId) {
                        showVillageDetails(selectedVillageId); // Refresh details if a village is selected
                    }
                });

                function renderAccountsAndVillages() {
                    const accList = document.getElementById('account-list');
                    if (accList) accList.innerHTML = '<ul>' + (FULL_STATE.accounts || []).map(acc => `<li>${acc.username} @ ${acc.server_url} <button onclick="removeAccount('${acc.username}')">X</button></li>`).join('') + '</ul>';

                    const villageList = document.getElementById('village-list');
                    if (villageList) {
                        villageList.innerHTML = '';
                        // The village list is now stored under the username key initially
                        for (const username in FULL_STATE.village_data) {
                            const villageData = FULL_STATE.village_data[username];
                            if (Array.isArray(villageData)) {
                                villageData.forEach(village => {
                                    villageList.innerHTML += `<div class="village-list-item" id="village-item-${village.id}" onclick="showVillageDetails('${village.id}')">${village.name}</div>`;
                                });
                            }
                        }
                    }
                }

                function showVillageDetails(villageId) {
                    selectedVillageId = villageId;
                    document.querySelectorAll('.village-list-item').forEach(el => el.classList.remove('active'));
                    const villageElement = document.getElementById(`village-item-${villageId}`);
                    if (villageElement) villageElement.classList.add('active');

                    const villageData = FULL_STATE.village_data[villageId];
                    const villageQueue = FULL_STATE.build_queues[villageId] || [];
                    const detailsDiv = document.getElementById('village-details');
                    
                    if (!villageData || !villageData.resources) {
                        detailsDiv.innerHTML = `<h2>Details for Village ${villageId}</h2><p>Waiting for data from agent...</p>`;
                        return;
                    }
                    
                    let villageName = "Unknown";
                    for (const username in FULL_STATE.village_data) {
                        if (Array.isArray(FULL_STATE.village_data[username])) {
                           const found = FULL_STATE.village_data[username].find(v => v.id == villageId);
                           if (found) { villageName = found.name; break; }
                        }
                    }

                    let html = `<h2>Village: ${villageName}</h2>`;
                    
                    html += '<h3>Resources</h3><table><tr><th>Resource</th><th>Current</th><th>Storage</th><th>Production/hr</th></tr>';
                    html += `<tr><td>Wood</td><td>${villageData.resources.l1}</td><td>${villageData.storage.l1}</td><td>${villageData.production.l1}</td></tr>`;
                    html += `<tr><td>Clay</td><td>${villageData.resources.l2}</td><td>${villageData.storage.l2}</td><td>${villageData.production.l2}</td></tr>`;
                    html += `<tr><td>Iron</td><td>${villageData.resources.l3}</td><td>${villageData.storage.l3}</td><td>${villageData.production.l3}</td></tr>`;
                    html += `<tr><td>Crop</td><td>${villageData.resources.l4}</td><td>${villageData.storage.l4}</td><td>${villageData.production.l4}</td></tr></table>`;

                    html += '<h3>Buildings</h3><table><tr><th>Location</th><th>Name</th><th>Level</th></tr>';
                    villageData.buildings.sort((a,b) => a.id - b.id).forEach(b => {
                        html += `<tr><td>${b.id}</td><td>${GID_NAMES[b.gid] || `GID ${b.gid}`}</td><td>${b.level}</td></tr>`;
                    });
                    html += '</table>';
                    
                    html += `<h3>Build Queue</h3><ol id="build-queue-list">`;
                    villageQueue.forEach((job, index) => {
                        html += `<li>${job.type === 'building' ? `${GID_NAMES[job.gid]} (Loc: ${job.location})` : 'Resource Fields'} to Level ${job.level} <button onclick="removeQueueItem('${villageId}', ${index})">X</button></li>`;
                    });
                    html += '</ol>';

                    html += `
                        <h3>Add to Queue</h3>
                        <form id="add-to-queue-form" onsubmit="addQueueItem(event, '${villageId}')">
                             <select id="new-job-gid"><option value="">--Select Building--</option>${Object.entries(GID_NAMES).map(([gid, name]) => `<option value="${gid}">${name}</option>`).join('')}</select>
                             <input type="number" id="new-job-location" placeholder="Location ID" required>
                             <input type="number" id="new-job-level" placeholder="Target Level" required>
                             <button type="submit">Add Job</button>
                        </form>
                    `;
                    detailsDiv.innerHTML = html;
                }

                function addQueueItem(event, villageId) {
                    event.preventDefault();
                    const gid = parseInt(document.getElementById('new-job-gid').value);
                    const location = parseInt(document.getElementById('new-job-location').value);
                    const level = parseInt(document.getElementById('new-job-level').value);

                    if (gid && location && level) {
                        const newJob = { type: 'building', gid, location, level };
                        const currentQueue = FULL_STATE.build_queues[villageId] || [];
                        currentQueue.push(newJob);
                        socket.emit('update_build_queue', { villageId: villageId, queue: currentQueue });
                    }
                }

                function removeQueueItem(villageId, index) {
                     const currentQueue = FULL_STATE.build_queues[villageId] || [];
                     currentQueue.splice(index, 1);
                     socket.emit('update_build_queue', { villageId: villageId, queue: currentQueue });
                }

                function addAccount(event) {
                    event.preventDefault();
                    socket.emit('add_account', { username: document.getElementById('username').value, password: document.getElementById('password').value, server_url: document.getElementById('server_url').value });
                    event.target.reset();
                }

                function removeAccount(username) {
                    if(confirm('Are you sure?')) socket.emit('remove_account', {username});
                }
                
                document.getElementById('startBtn').onclick = () => socket.emit('start_bot', {});
                document.getElementById('stopBtn').onclick = () => socket.emit('stop_bot', {});
                document.getElementById('add-account-form').onsubmit = addAccount;
            </script>
        </body>
        </html>
        