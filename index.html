<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travian Bot Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        :root {
            --bg-primary: #1e1e2e;
            --bg-secondary: #27293d;
            --bg-tertiary: #3b3e58;
            --text-primary: #f8f8f2;
            --text-secondary: #bd93f9;
            --text-muted: #6272a4;
            --accent-primary: #50fa7b;
            --accent-secondary: #ff79c6;
            --accent-highlight: #f1fa8c;
            --border-color: #44475a;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .main-container {
            display: flex;
            gap: 1rem;
            flex-grow: 1;
            height: calc(100% - 220px); /* Adjust based on log panel height */
            min-height: 400px;
        }

        .column {
            display: flex;
            flex-direction: column;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        #left-column { flex: 1; min-width: 300px; }
        #middle-column { flex: 1; min-width: 300px; }
        #right-column { flex: 3; min-width: 550px; }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-secondary);
            margin: 0;
        }
        
        .card-content {
            padding: 1.5rem;
            overflow-y: auto;
            flex-grow: 1;
        }
        
        .log-panel {
            margin-top: 1rem;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 220px;
            overflow: hidden;
        }

        #log {
            background-color: #111;
            padding: 1rem;
            border-radius: 6px;
            height: 100%;
            overflow-y: scroll;
            font-family: monospace;
            font-size: 0.9em;
            box-sizing: border-box;
            flex-grow: 1;
        }

        .collapsible-section .collapsible-content { display: none; padding-top: 1rem; }
        .collapsible-section.open .collapsible-content { display: block; }
        .collapsible-header { cursor: pointer; padding: 0.5rem 0; margin-top: 1.5rem; }
        .collapsible-header h3 { margin: 0; color: var(--text-secondary); }

        .btn {
            background-color: var(--bg-tertiary); color: var(--text-primary); border: none;
            padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer;
            transition: background-color 0.2s; font-weight: 500;
        }
        .btn:hover { background-color: #44475a; }
        .btn-primary { background-color: var(--accent-primary); color: var(--bg-primary); }
        .btn-danger { background-color: var(--accent-secondary); color: var(--bg-primary); }
        .btn-small { padding: 0.4rem 0.8rem; font-size: 0.8rem; }

        .form-group { margin-bottom: 1rem; }
        .form-control {
            width: 100%; background-color: var(--bg-tertiary); color: var(--text-primary);
            border: 1px solid var(--border-color); padding: 0.75rem;
            border-radius: 6px; box-sizing: border-box;
        }

        .item-list { list-style: none; padding: 0; margin: 0; }
        .list-item {
            padding: 1rem; border-radius: 6px; cursor: pointer;
            transition: background-color 0.2s; border-bottom: 1px solid var(--border-color);
        }
        .list-item:hover { background-color: var(--bg-tertiary); }
        .list-item.active { background-color: var(--text-secondary); color: var(--bg-primary); font-weight: 700; }
        .account-header {
            padding: 0.5rem 1rem; background-color: var(--bg-tertiary); font-weight: 700;
            color: var(--text-secondary); margin-top: 1rem; border-radius: 4px;
        }

        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { font-weight: 700; color: var(--text-secondary); }

        .tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 1rem; flex-shrink: 0; }
        .tab { padding: 1rem; cursor: pointer; border-bottom: 3px solid transparent; font-size: 0.9rem; }
        .tab.active { color: var(--accent-primary); border-bottom: 3px solid var(--accent-primary); font-weight: 700; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .draggable {
            cursor: move; background-color: var(--bg-tertiary); padding: 0.75rem;
            margin-bottom: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color);
        }
        .drag-over { border-top: 2px solid var(--accent-primary); }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- ACCOUNTS COLUMN -->
        <div id="left-column" class="column">
            <div class="card-header">
                <h2 class="card-title">Accounts</h2>
            </div>
            <div class="card-content">
                <div id="account-list"></div>
                <div class="collapsible-section" id="add-account-section">
                    <div class="collapsible-header" onclick="toggleCollapsible('add-account-section')">
                        <h3>+ Add New Account</h3>
                    </div>
                    <div class="collapsible-content">
                        <form id="add-account-form">
                            <div class="form-group"><input type="text" id="username" class="form-control" placeholder="Username" required></div>
                            <small>For sitter accounts, this will be combined with the sitter name (e.g., username_sitter).</small>
                            <div class="form-group"><input type="password" id="password" class="form-control" placeholder="Password" required></div>
                            <div class="form-group"><input type="text" id="server_url" class="form-control" placeholder="Server URL" required></div>
                            <div class="form-group"><label><input type="checkbox" id="use_dual_queue"> Use Plus Account (2 builds)</label></div>
                            <div class="form-group"><label><input type="checkbox" id="use_hero_resources"> Use Hero Resources</label></div>
                            <div class="form-group">
                                <label><input type="checkbox" id="is_sitter"> Is this a sitter account?</label>
                            </div>
                            <div class="form-group">
                                <input type="text" id="sitter_for" class="form-control" placeholder="Account you are sitting for">
                            </div>
                            <hr style="border-color: var(--border-color); margin: 1.5rem 0;">
                            <h4 style="color: var(--text-secondary);">Proxy (Optional)</h4>
                            <div class="form-group"><input type="text" id="proxy_ip" class="form-control" placeholder="Proxy IP/Host"></div>
                            <div class="form-group"><input type="text" id="proxy_port" class="form-control" placeholder="Proxy Port"></div>
                            <div class="form-group"><input type="text" id="proxy_user" class="form-control" placeholder="Proxy Username"></div>
                            <div class="form-group"><input type="password" id="proxy_pass" class="form-control" placeholder="Proxy Password"></div>
                            <button type="submit" class="btn" style="width: 100%;">Add Account</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- VILLAGES COLUMN -->
        <div id="middle-column" class="column">
            <div class="card-header">
                <h2 class="card-title">Villages</h2>
            </div>
            <div id="village-list-content" class="card-content">
                <ul id="village-list" class="item-list"></ul>
            </div>
        </div>

        <!-- DETAIL PANE -->
        <div id="right-column" class="column">
            <div id="detail-pane-header" class="card-header">
                 <h2 class="card-title" id="village-details-title">Select a Village</h2>
            </div>
            <div id="village-details-content" class="card-content">
                <div style="text-align: center; padding-top: 5rem;">
                    <h2 style="color: var(--text-secondary);">Welcome to the Travian Bot!</h2>
                    <p style="color: var(--text-muted); font-size: 1.1rem;">Start an account from the 'Accounts' panel to begin.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- LOG PANEL -->
    <div class="log-panel">
        <div class="card-header">
            <h2 class="card-title">Live Log</h2>
             <div style="display: flex; gap: 1rem;">
                <select id="log-level-filter" class="form-control" style="width: auto;">
                    <option value="">All Levels</option>
                    <option value="INFO">INFO</option>
                    <option value="WARNING">WARNING</option>
                    <option value="ERROR">ERROR</option>
                </select>
                <input type="text" id="log-search-filter" class="form-control" placeholder="Search logs..." style="width: auto;">
            </div>
        </div>
        <div id="log"></div>
    </div>

    <script>
        const socket = io();
        let FULL_STATE = {};
        const GID_MAP = {1:"Woodcutter",2:"Clay Pit",3:"Iron Mine",4:"Cropland",5:"Sawmill",6:"Brickyard",7:"Iron Foundry",8:"Grain Mill",9:"Bakery",10:"Warehouse",11:"Granary",13:"Smithy",14:"Tournament Square",15:"Main Building",16:"Rally Point",17:"Marketplace",18:"Embassy",19:"Barracks",20:"Stable",21:"Workshop",22:"Academy",23:"Cranny",24:"Town Hall",25:"Residence",26:"Palace",27:"Treasury",28:"Trade Office",29:"Great Barracks",30:"Great Stable",31:"City Wall",32:"Earth Wall",33:"Palisade",34:"Stonemason's Lodge",35:"Brewery",36:"Trapper",37:"Hero's Mansion",38:"Great Warehouse",39:"Great Granary",40:"Wonder of the World",41:"Horse Drinking Trough",42:"Stone Wall",43:"Makeshift Wall",44:"Command Center",45:"Waterworks",46:"Hospital"};
        let selectedVillageId = null;
        let selectedAccountUsername = null;
        let currentTab = 'fields';
        let isUserInteracting = false;

        // --- EVENT LISTENERS ---
        document.addEventListener('focusin', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
                isUserInteracting = true;
            }
        });
        document.addEventListener('focusout', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
                isUserInteracting = false;
            }
        });

        socket.on('connect', () => {
            const log = document.getElementById('log');
            if(log) log.innerHTML += '<div data-log-level="INFO" style="color:var(--accent-primary)">Dashboard connected.</div>';
        });

        socket.on('log_message', msg => {
            const log = document.getElementById('log');
            if (log) {
                const logLevelMatch = msg.data.match(/^\[(INFO|WARNING|ERROR)\]/);
                const logLevel = logLevelMatch ? logLevelMatch[1] : 'INFO';
                const logEntry = document.createElement('div');
                logEntry.dataset.logLevel = logLevel;
                let color = 'var(--text-primary)';
                if (logLevel === 'WARNING') color = 'var(--accent-highlight)';
                if (logLevel === 'ERROR') color = 'var(--accent-secondary)';
                logEntry.style.color = color;
                logEntry.innerHTML = msg.data.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                log.appendChild(logEntry);
                log.scrollTop = log.scrollHeight;
                filterLogs(); 
            }
        });

        let isRenderScheduled = false;
        function scheduleRender() {
            if (!isRenderScheduled) {
                isRenderScheduled = true;
                requestAnimationFrame(() => {
                    renderUI();
                    isRenderScheduled = false;
                });
            }
        }

        socket.on('state_update', newState => {
            FULL_STATE = newState;
            scheduleRender();
        });

        socket.on('villages_discovered', (data) => {
            const { username, villages } = data;
            console.log(`Villages discovered for ${username}, forcing immediate UI update.`);
            if (!FULL_STATE.village_data) {
                FULL_STATE.village_data = {};
            }
            FULL_STATE.village_data[username] = villages;
            renderUI();
        });

        // --- UI RENDERING FUNCTIONS ---
        function renderUI() {
            renderAccounts();
            renderVillages();
            if (selectedVillageId) {
                showVillageDetails(selectedVillageId, false); 
            } else {
                renderGlobalSummary();
            }
        }
        
        function renderGlobalSummary() {
            document.getElementById('detail-pane-header').innerHTML = `<h2 class="card-title">Dashboard</h2>`;
            document.getElementById('village-details-content').innerHTML = `
                <div style="text-align: center; padding-top: 5rem;">
                    <h2 style="color: var(--text-secondary);">Welcome to the Travian Bot!</h2>
                    <p style="color: var(--text-muted); font-size: 1.1rem;">Select an account to see its villages, or add a new one to begin.</p>
                </div>`;
        }
        
        function renderAccounts() {
            const accList = document.getElementById('account-list');
            if (!accList) return;

            let html = '<ul class="item-list">';
            (FULL_STATE.accounts || []).forEach(acc => {
                const status = acc.active ? 'Running' : 'Stopped';
                const statusColor = acc.active ? 'var(--accent-primary)' : 'var(--accent-secondary)';
                const actionButton = acc.active 
                    ? `<button class="btn btn-danger btn-small" onclick="event.stopPropagation(); stopAccount('${acc.username}')">Stop</button>`
                    : `<button class="btn btn-primary btn-small" onclick="event.stopPropagation(); startAccount('${acc.username}')">Start</button>`;
                
                html += `
                    <li class="list-item ${selectedAccountUsername === acc.username ? 'active' : ''}" onclick="selectAccount('${acc.username}')" style="background-color: var(--bg-tertiary); padding: 0.75rem; border-radius: 6px; margin-bottom: 0.75rem; border: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong style="font-size: 1.1rem;">${acc.username}</strong>
                            <div>
                                ${actionButton}
                                <button class="btn btn-small" style="background-color: #6272a4;" onclick="event.stopPropagation(); removeAccount('${acc.username}')">X</button>
                            </div>
                        </div>
                        <div><span style="font-weight: bold; color: ${statusColor};">${status}</span></div>
                    </li>`;
            });
            html += '</ul>';
            accList.innerHTML = html;
        }

        function renderVillages() {
            const villageList = document.getElementById('village-list');
            if (!villageList) return;
            villageList.innerHTML = '';

            let accountsToRender = FULL_STATE.accounts || [];
            if(selectedAccountUsername) {
                accountsToRender = accountsToRender.filter(acc => acc.username === selectedAccountUsername);
            }
            
            accountsToRender.forEach(account => {
                const villageData = FULL_STATE.village_data[account.username];
                if (Array.isArray(villageData) && villageData.length > 0) {
                     villageList.innerHTML += `<div class="account-header">${account.username}</div>`;
                    villageData.forEach(village => {
                        const activeClass = village.id == selectedVillageId ? 'active' : '';
                        villageList.innerHTML += `<li class="list-item ${activeClass}" id="village-item-${village.id}" onclick="showVillageDetails('${village.id}', true)">${village.name}</li>`;
                    });
                }
            });
        }
        
        function selectAccount(username) {
            selectedAccountUsername = (selectedAccountUsername === username) ? null : username;
            selectedVillageId = null; 
            renderUI();
        }

        function showVillageDetails(villageId, userClicked = true) {
            if (isUserInteracting && !userClicked) {
                return; 
            }
            if (userClicked) {
                selectedVillageId = villageId;
            }
            if (!selectedVillageId) {
                renderGlobalSummary();
                return;
            }

            const villageData = FULL_STATE.village_data[selectedVillageId];
            if (!villageData || !villageData.resources || !villageData.buildings) {
                return; 
            }

            let villageName = '';
            for (const user in FULL_STATE.village_data) {
                const villages = FULL_STATE.village_data[user];
                if (Array.isArray(villages)) {
                    const village = villages.find(v => v.id == selectedVillageId);
                    if (village) {
                        villageName = village.name;
                        break;
                    }
                }
            }
            
            renderVillages(); 

            let tabsHtml = `<div class="tabs">
                                <div class="tab" id="tab-fields" onclick="openTab(event, 'fields')">Fields</div>
                                <div class="tab" id="tab-buildings" onclick="openTab(event, 'buildings')">City</div>
                                <div class="tab" id="tab-training" onclick="openTab(event, 'training')">Training</div>
                                <div class="tab" id="tab-smithy" onclick="openTab(event, 'smithy')">Smithy</div>
                                <div class="tab" id="tab-demolish" onclick="openTab(event, 'demolish')">Demolish</div>
                                <div class="tab" id="tab-new" onclick="openTab(event, 'new')">New Build</div>
                            </div>`;
            document.getElementById('detail-pane-header').innerHTML = `<h2 class="card-title">${villageName}</h2>${tabsHtml}`;
            
            const detailsDiv = document.getElementById('village-details-content');
            
            const villageQueue = FULL_STATE.build_queues[villageId] || [];
            const demolishQueue = FULL_STATE.demolish_queues ? (FULL_STATE.demolish_queues[villageId] || []) : [];
            const trainingSettingsForVillage = (FULL_STATE.training_queues || {})[villageId] || {};
            const trainingDataForVillage = (FULL_STATE.training_data || {})[villageId] || {};

            const projectedBuildings = JSON.parse(JSON.stringify(villageData.buildings));
            
            function getActionControls(villageId, building) {
                const currentLevelInQueue = villageQueue.filter(q => q.location === building.id).reduce((maxLvl, q) => Math.max(maxLvl, q.level), building.level);
                const maxLvl = getMaxLevel(building.gid);
                const isUpgradeable = currentLevelInQueue < maxLvl;
                const nextLevel = currentLevelInQueue + 1;

                if (!isUpgradeable) return `<button class="btn" disabled>Max Level</button>`;

                return `<div style="display:flex; align-items:center; gap: 10px;">
                            <input type="number" id="level-input-${villageId}-${building.id}" class="form-control" min="${nextLevel}" max="${maxLvl}" value="${nextLevel}" style="width: 80px;">
                            <button onclick="queueUpgradeTask('${villageId}', '${building.id}', '${building.gid}', 'level-input-${villageId}-${building.id}')" class="btn">Queue</button>
                            <button onclick="queueToMax('${villageId}', '${building.id}', '${building.gid}')" class="btn" style="background-color: var(--accent-highlight); color: var(--bg-primary);">Max</button>
                        </div>`;
            }

            let fieldsContent = '<div id="fields" class="tab-content">';
            fieldsContent += `<div class="resource-upgrade-form" style="padding: 1rem; background-color: var(--bg-tertiary); border-radius: 6px; margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem;">
                                 <label for="resource-target-level-${villageId}">Set Resource Plan Target Level:</label>
                                 <input type="number" id="resource-target-level-${villageId}" value="10" min="1" max="50" class="form-control" style="width: 80px;">
                                 <button onclick="upgradeAllResources('${villageId}')" class="btn">Set Plan</button>
                               </div>`;
            fieldsContent += '<table><thead><tr><th>Location</th><th>Name</th><th>Level</th><th>Actions</th></tr></thead><tbody>';
            projectedBuildings.filter(b => b.id <= 18).sort((a,b) => a.id - b.id).forEach(b => {
                fieldsContent += `<tr><td>${b.id}</td><td>${GID_MAP[b.gid] || `GID ${b.gid}`}</td><td>${b.level}</td><td>${getActionControls(villageId, b)}</td></tr>`;
            });
            fieldsContent += '</tbody></table></div>';
            
            let buildingsContent = '<div id="buildings" class="tab-content"><table><thead><tr><th>Location</th><th>Name</th><th>Level</th><th>Actions</th></tr></thead><tbody>';
            projectedBuildings.filter(b => b.id > 18 && b.gid > 0).sort((a,b) => a.id - b.id).forEach(b => {
                buildingsContent += `<tr><td>${b.name || GID_MAP[b.gid] || `GID ${b.gid}`}</td><td>${b.level}</td><td>${getActionControls(villageId, b)}</td></tr>`;
            });
            buildingsContent += '</tbody></table></div>';
            
            let trainingContent = `<div id="training" class="tab-content"><h3>Troop Training Configuration</h3>`;
            trainingContent += `<div style="margin-bottom: 1.5rem; display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; background-color: var(--bg-tertiary); padding: 1rem; border-radius: 6px;">
                                    <button onclick="saveTrainingSettings('${villageId}')" class="btn btn-primary">Save Settings</button>
                                    <div id="training-copy-container" style="display:contents;"></div>
                                </div>`;
            trainingContent += `<div class="form-group" style="padding: 1rem; border: 1px solid var(--border-color); border-radius: 6px;">
                                    <label><input type="checkbox" id="training-enabled-${villageId}" ${trainingSettingsForVillage.enabled ? 'checked' : ''}> Enable Training Agent</label>
                                    <label style="display: block; margin-top: 1rem;">Min Queue (minutes): <input type="number" id="min-queue-duration-${villageId}" class="form-control" style="width: 100px; display: inline-block;" value="${trainingSettingsForVillage.min_queue_duration_minutes || 15}"></label>
                                    <label style="display: block; margin-top: 1rem;">End Time (dd.mm.yyyy hh:mm): <input type="text" id="max-training-time-${villageId}" class="form-control" style="width: 250px; display: inline-block;" value="${trainingSettingsForVillage.max_training_time || ''}"></label>
                                </div>`;

            const buildingTypes = {
                barracks: { gid: 19, name: 'Barracks' }, stable: { gid: 20, name: 'Stable' },
                workshop: { gid: 21, name: 'Workshop' }, great_barracks: { gid: 29, name: 'Great Barracks'}, great_stable: { gid: 30, name: 'Great Stable'}
            };

            Object.entries(buildingTypes).forEach(([key, value]) => {
                const buildingData = (trainingDataForVillage || {})[value.gid];
                if (!buildingData) return;
                const buildingConfig = (trainingSettingsForVillage.buildings || {})[key] || {};
                let optionsHtml = '<option value="">-- Select Troop --</option>';
                (buildingData.trainable || []).forEach(troop => {
                    optionsHtml += `<option value="${troop.name}" ${troop.name === buildingConfig.troop_name ? 'selected' : ''}>${troop.name}</option>`;
                });
                let queueHtml = (buildingData.training_queue && buildingData.training_queue.length > 0)
                    ? `<h4>In Training</h4><table><thead><tr><th>Amount</th><th>Troop</th><th>Duration</th></tr></thead><tbody>${buildingData.training_queue.map(q => `<tr><td>${q.amount.toLocaleString()}</td><td>${q.name}</td><td>${formatDuration(q.duration)}</td></tr>`).join('')}</tbody></table>`
                    : '<p>No troops currently in training.</p>';

                trainingContent += `<div class="collapsible-section" style="margin-top: 1rem; border: 1px solid var(--text-muted); border-radius: 6px;">
                                        <div class="card-header" style="padding: 1rem 1.5rem; cursor: pointer;" onclick="this.parentElement.classList.toggle('open')">
                                            <h4 class="card-title" style="font-size: 1.1rem; color: var(--text-primary); text-transform: capitalize;">${value.name}</h4>
                                        </div>
                                        <div class="card-content collapsible-content" style="padding: 1.2rem;">
                                            <div class="form-group"><label><input type="checkbox" id="train-enabled-${villageId}-${key}" ${buildingConfig.enabled ? 'checked' : ''}> Enable</label></div>
                                            <div class="form-group"><label>Troop to Train:</label><select id="train-select-${villageId}-${key}" class="form-control">${optionsHtml}</select></div>
                                            <hr style="border-color: var(--border-color); margin: 1.5rem 0;">
                                            ${queueHtml}
                                        </div>
                                    </div>`;
            });
            trainingContent += `</div>`;

            let demolishContent = `<div id="demolish" class="tab-content"><h3>Demolish Building</h3><p>Queue demolition tasks. One task per level.</p><table><thead><tr><th>Name</th><th>Level</th><th>Action</th></tr></thead><tbody>`;
            villageData.buildings.filter(b => b.gid > 0 && b.id > 18 && b.level > 0).sort((a, b) => (a.name || GID_MAP[a.gid]).localeCompare(b.name || GID_MAP[b.gid])).forEach(b => {
                demolishContent += `<tr><td>${b.name || GID_MAP[b.gid]}</td><td>${b.level}</td><td><div style="display:flex; align-items:center; gap: 10px;"><input type="number" id="demolish-level-input-${villageId}-${b.id}" class="form-control" min="0" max="${b.level - 1}" value="${b.level - 1}" style="width: 80px;"><button onclick="queueDemolishTask('${villageId}', {id: ${b.id}, gid: ${b.gid}, level: ${b.level}})" class="btn btn-danger">Queue</button></div></td></tr>`;
            });
            demolishContent += `</tbody></table><h3 style="margin-top: 2rem;">Demolition Queue (${demolishQueue.length})</h3><ol id="demolish-queue-list" style="list-style-type: none; padding: 0;">`;
            demolishQueue.forEach((job, index) => {
                 demolishContent += `<li style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-radius: 4px; background-color: var(--bg-tertiary); margin-bottom: 0.5rem;"><span>${index + 1}. Demolish ${GID_MAP[job.gid] || 'Unknown'} to Lvl ${job.level}</span><button class="btn btn-small btn-danger" onclick="removeDemolishQueueItem('${villageId}', ${index})">X</button></li>`;
            });
            demolishContent += '</ol></div>';

            let newBuildContent = '<div id="new" class="tab-content"><h4>Build in Empty Slot</h4><table><thead><tr><th>Location</th><th>Action</th></tr></thead><tbody>';
            const baseBuildable = [5,6,7,8,9,10,11,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46];
            const existingUniqueGids = new Set(projectedBuildings.filter(b => b.gid > 0 && !is_multi_instance(b.gid)).map(b => b.gid));
            const buildableGIDs = baseBuildable.filter(g => !existingUniqueGids.has(g));
            villageData.buildings.filter(b => b.id > 18 && b.gid === 0).forEach(slot => {
                const queuedBuilding = villageQueue.find(q => q.location === slot.id);
                if (!queuedBuilding) {
                    let allowedGIDs = buildableGIDs.slice();
                    if (slot.id === 40) allowedGIDs = [getWallGid(villageData)];
                    else if (slot.id === 39) allowedGIDs = [16];
                    let optionsHtml = '<option value="0">-- Select Building --</option>' + allowedGIDs.map(gid => `<option value="${gid}">${GID_MAP[gid]}</option>`).join('');
                    newBuildContent += `<tr><td>${slot.id}</td><td><div style="display:flex; align-items:center; gap: 10px;"><select id="gid-select-${villageId}-${slot.id}" class="form-control" style="width: auto;">${optionsHtml}</select><input type="number" id="level-input-new-${villageId}-${slot.id}" class="form-control" min="1" max="20" value="1" style="width: 80px;"><button onclick="addNewBuildingTask('${villageId}', '${slot.id}', 'gid-select-${villageId}-${slot.id}', 'level-input-new-${villageId}-${slot.id}')" class="btn">Queue</button></div></td></tr>`;
                }
            });
            newBuildContent += '</tbody></table></div>';
            
            let queueHtml = `<h3 style="margin-top: 2rem;">Build Queue (${villageQueue.length})</h3><div style="background-color: var(--bg-tertiary); padding: 1rem; border-radius: 6px; margin-bottom: 1rem;"><h4>Templates</h4><div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem;"><input type="text" id="template-name-input" class="form-control" placeholder="Template Name"><button onclick="saveTemplate('${villageId}')" class="btn btn-primary">Save</button></div><div id="template-list-container" style="display: flex; gap: 1rem; align-items: center;"></div></div>`;
            queueHtml += `<ol id="build-queue-list" style="list-style-type: none; padding: 0;">`;
            villageQueue.forEach((job, index) => {
                let jobName = (job.type === 'resource_plan') ? `ALL RESOURCES PLAN` : `${GID_MAP[job.gid] || 'Unknown'} (Loc: ${job.location || '??'})`;
                queueHtml += `<li style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-radius: 4px; background-color: var(--bg-tertiary); margin-bottom: 0.5rem;"><span>${index + 1}. ${jobName} to Lvl ${job.level}</span><div><button class="btn btn-small" onclick="moveQueueItem('${villageId}', ${index}, 'top')">Top</button><button class="btn btn-small" onclick="moveQueueItem('${villageId}', ${index}, 'up')">Up</button><button class="btn btn-small" onclick="moveQueueItem('${villageId}', ${index}, 'down')">Down</button><button class="btn btn-small" onclick="moveQueueItem('${villageId}', ${index}, 'bottom')">Bottom</button><button class="btn btn-small btn-danger" onclick="removeQueueItem('${villageId}', ${index})">X</button></div></li>`;
            });
            queueHtml += '</ol>';

            let smithyContent = `<div id="smithy" class="tab-content"><h3>Smithy Upgrade Priority</h3></div>`;
            detailsDiv.innerHTML = fieldsContent + buildingsContent + trainingContent + smithyContent + demolishContent + newBuildContent + queueHtml;
            renderCopyControls(villageId, 'training');
            renderTemplateList(villageId);
            renderSmithyUpgrades(villageId);
            renderCopyControls(villageId, 'smithy');
            openTab(null, currentTab);
        }

        // --- All other helper and utility functions ---
        function openTab(event, tabName) {
            if (event) currentTab = tabName;
            document.querySelectorAll('#right-column .tab-content').forEach(tc => tc.style.display = 'none');
            document.querySelectorAll('#detail-pane-header .tab').forEach(t => t.classList.remove('active'));
            const tabContent = document.getElementById(currentTab);
            if (tabContent) tabContent.style.display = 'block';
            const tabButton = document.getElementById(`tab-${currentTab}`);
            if(tabButton) tabButton.classList.add('active');
        }
        function renderCopyControls(villageId, settingType) {
            const container = document.getElementById(`${settingType}-copy-container`);
            if (!container) return;
            let sourceAccountUsername = null;
            for (const username in FULL_STATE.village_data) {
                if (Array.isArray(FULL_STATE.village_data[username]) && FULL_STATE.village_data[username].some(v => v.id == villageId)) {
                    sourceAccountUsername = username;
                    break;
                }
            }
            if (!sourceAccountUsername) return;
            const otherVillages = (FULL_STATE.village_data[sourceAccountUsername] || []).filter(v => v.id != villageId);
            let optionsHtml = '<option value="">-- Select Target --</option><option value="__ALL__">All Other Villages</option>';
            otherVillages.forEach(v => { optionsHtml += `<option value="${v.id}">${v.name}</option>`; });
            container.innerHTML = `<div class="copy-controls" style="display: flex; gap: 0.5rem; align-items: center;"><label>Copy to:</label><select id="${settingType}-copy-target-select" class="form-control" style="width: auto;">${optionsHtml}</select><button onclick="copySettings('${villageId}', '${settingType}')" class="btn">Copy</button></div>`;
        }
        function renderSmithyUpgrades(villageId) {
            const smithyTab = document.getElementById('smithy');
            if (!smithyTab) return;
            const smithySettings = (FULL_STATE.smithy_upgrades || {})[villageId] || { enabled: false, priority: [] };
            const villageDetails = FULL_STATE.village_data[villageId];
            const smithyBuilding = (villageDetails.buildings || []).find(b => b.gid === 13);
            if (!smithyBuilding) {
                smithyTab.innerHTML = '<h3>Smithy not found in this village.</h3>';
                return;
            }
            let html = `<div style="margin-bottom: 1.5rem; display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; background-color: var(--bg-tertiary); padding: 1rem; border-radius: 6px;"><button onclick="saveSmithySettings('${villageId}')" class="btn btn-primary">Save</button><div id="smithy-copy-container" style="display:contents;"></div></div><div class="form-group" style="padding: 1rem; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 1.5rem;"><label><input type="checkbox" id="smithy-enabled-${villageId}" ${smithySettings.enabled ? 'checked' : ''} onchange="saveSmithySettings('${villageId}')"> Enable Auto Upgrades</label></div><h4>Priority (drag to reorder)</h4><div id="smithy-priority-list-${villageId}" class="priority-list"></div>`;
            smithyTab.innerHTML = html;
            const priorityListEl = document.getElementById(`smithy-priority-list-${villageId}`);
            const smithyData = (FULL_STATE.smithy_data || {})[villageId] || {};
            const availableResearches = smithyData.researches || [];
            const priority = smithySettings.priority || [];
            const prioritySet = new Set(priority);
            const nonPriorityResearches = availableResearches.filter(r => !prioritySet.has(r.name));
            const sortedResearches = [...priority.map(name => availableResearches.find(r => r.name === name)).filter(Boolean), ...nonPriorityResearches];
            sortedResearches.forEach(research => {
                const item = document.createElement('div');
                item.className = 'draggable';
                item.draggable = true;
                item.textContent = `${research.name} (Level ${research.level})`;
                item.dataset.unitName = research.name;
                priorityListEl.appendChild(item);
            });
            let draggedItem = null;
            priorityListEl.addEventListener('dragstart', (e) => { draggedItem = e.target; e.target.style.opacity = '0.5'; });
            priorityListEl.addEventListener('dragend', (e) => { e.target.style.opacity = '1'; draggedItem = null; saveSmithySettings(villageId); });
            priorityListEl.addEventListener('dragover', (e) => { e.preventDefault(); const afterElement = getDragAfterElement(priorityListEl, e.clientY); if (afterElement == null) { priorityListEl.appendChild(draggedItem); } else { priorityListEl.insertBefore(draggedItem, afterElement); } });
        }
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')];
            return draggableElements.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } else { return closest; } }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        function saveSmithySettings(villageId) {
            const enabled = document.getElementById(`smithy-enabled-${villageId}`).checked;
            const priorityListEl = document.getElementById(`smithy-priority-list-${villageId}`);
            const priority = [...priorityListEl.querySelectorAll('.draggable')].map(item => item.dataset.unitName);
            socket.emit('update_smithy_upgrades', { villageId, settings: { enabled, priority } });
        }
        function renderTemplateList(villageId) {
            const container = document.getElementById('template-list-container');
            if (!container) return;
            const templates = FULL_STATE.build_templates || {};
            let html = `<select id="template-select" class="form-control" style="flex-grow: 1;"><option value="">-- Load Template --</option>`;
            for (const name in templates) { html += `<option value="${name}">${name}</option>`; }
            html += `</select><button onclick="loadTemplate('${villageId}')" class="btn">Load</button><button onclick="deleteTemplate()" class="btn btn-danger">Delete</button>`;
            container.innerHTML = html;
        }
        document.getElementById('add-account-form').onsubmit = (e) => { e.preventDefault(); socket.emit('add_account', { username: document.getElementById('username').value, password: document.getElementById('password').value, server_url: document.getElementById('server_url').value, is_sitter: document.getElementById('is_sitter').checked, sitter_for: document.getElementById('sitter_for').value, use_dual_queue: document.getElementById('use_dual_queue').checked, use_hero_resources: document.getElementById('use_hero_resources').checked, proxy_ip: document.getElementById('proxy_ip').value, proxy_port: document.getElementById('proxy_port').value, proxy_user: document.getElementById('proxy_user').value, proxy_pass: document.getElementById('proxy_pass').value }); e.target.reset(); toggleCollapsible('add-account-section'); };
        function filterLogs() { const levelFilter = document.getElementById('log-level-filter').value; const searchFilter = document.getElementById('log-search-filter').value.toLowerCase(); const logContainer = document.getElementById('log'); if (!logContainer) return; const entries = logContainer.getElementsByTagName('div'); for (const entry of entries) { const levelMatch = !levelFilter || entry.dataset.logLevel === levelFilter; const searchMatch = !searchFilter || entry.textContent.toLowerCase().includes(searchFilter); entry.style.display = (levelMatch && searchMatch) ? '' : 'none'; } }
        document.getElementById('log-level-filter').onchange = filterLogs;
        document.getElementById('log-search-filter').onkeyup = filterLogs;
        function toggleCollapsible(sectionId) { document.getElementById(sectionId).classList.toggle('open'); }
        function startAccount(username) { socket.emit('start_account', {username}); }
        function stopAccount(username) { socket.emit('stop_account', {username}); }
        function removeAccount(username) { if(confirm(`Are you sure you want to remove account: ${username}?`)) { socket.emit('remove_account', {username}); } }
        function moveQueueItem(villageId, index, direction) { socket.emit('move_build_queue_item', { villageId, index, direction }); }
        function removeQueueItem(villageId, index) { const q = FULL_STATE.build_queues[villageId] || []; q.splice(index, 1); socket.emit('update_build_queue', { villageId, queue: q }); }
        function saveTrainingSettings(villageId) { const settings = { enabled: document.getElementById(`training-enabled-${villageId}`).checked, min_queue_duration_minutes: parseInt(document.getElementById(`min-queue-duration-${villageId}`).value, 10), max_training_time: document.getElementById(`max-training-time-${villageId}`).value, buildings: {} }; const buildingTypes = ["barracks", "stable", "workshop", "great_barracks", "great_stable"]; const gids = [19, 20, 21, 29, 30]; buildingTypes.forEach((key, index) => { const enableCheckbox = document.getElementById(`train-enabled-${villageId}-${key}`); const troopSelect = document.getElementById(`train-select-${villageId}-${key}`); if(enableCheckbox && troopSelect){ settings.buildings[key] = { gid: gids[index], enabled: enableCheckbox.checked, troop_name: troopSelect.value }; } }); socket.emit('update_training_queues', { villageId: villageId, settings: settings }); }
        function copySettings(sourceVillageId, settingType) { const targetSelect = document.getElementById(`${settingType}-copy-target-select`); const targetVillageId = targetSelect.value; if (!targetVillageId) return; if (confirm(`Copy ${settingType} settings to ${targetVillageId === '__ALL__' ? 'all other villages' : 'the selected village'}?`)) { socket.emit('copy_settings', { source_village_id: sourceVillageId, target_village_id: targetVillageId, setting_type: settingType }); } }
        function getMaxLevel(gid) { gid = parseInt(gid); if ([1,2,3,4].includes(gid)) return 50; if (gid === 40) return 100; if (gid === 23) return 10; if ([5,6,7,8,9].includes(gid)) return 5; return 20; }
        function getWallGid(villageData) { const wallGids = [31,32,33,42,43]; const slot40 = villageData.buildings.find(b => b.id === 40 && wallGids.includes(b.gid)); if (slot40) return slot40.gid; const existing = villageData.buildings.find(b => wallGids.includes(b.gid)); if (existing) return existing.gid; return 31; }
        function addBuildTask(villageId, location, gid, level, isMax = false) { const maxLevel = getMaxLevel(gid); const targetLevel = isMax ? maxLevel : parseInt(level); if (isNaN(targetLevel) || targetLevel <= 0 || targetLevel > maxLevel) return; const task = { type: 'building', location: parseInt(location), gid: parseInt(gid), level: targetLevel }; socket.emit('add_build_task', { villageId, task }); }
        function upgradeAllResources(villageId) { const targetLevelInput = document.getElementById(`resource-target-level-${villageId}`); const targetLevel = parseInt(targetLevelInput.value); if (isNaN(targetLevel) || targetLevel < 1 || targetLevel > 45) return; const task = { type: 'resource_plan', level: targetLevel }; let currentQueue = FULL_STATE.build_queues[villageId] || []; currentQueue.push(task); socket.emit('update_build_queue', { villageId, queue: currentQueue }); }
        function addNewBuildingTask(villageId, location, selectElementId, levelInputElementId) { const select = document.getElementById(selectElementId); const levelInput = document.getElementById(levelInputElementId); const gid = select.value; const level = levelInput.value; if (!gid || gid === "0") return; addBuildTask(villageId, location, gid, level, false); }
        function queueDemolishTask(villageId, building) { const levelInput = document.getElementById(`demolish-level-input-${villageId}-${building.id}`); const targetLevel = parseInt(levelInput.value, 10); if (isNaN(targetLevel) || targetLevel < 0 || targetLevel >= building.level) return; let demolishQueue = FULL_STATE.demolish_queues[villageId] || []; for (let i = building.level; i > targetLevel; i--) { demolishQueue.push({ type: 'demolish', location: building.id, gid: building.gid, level: i - 1 }); } const uniqueTasks = Array.from(new Set(demolishQueue.map(JSON.stringify))).map(JSON.parse); uniqueTasks.sort((a, b) => (a.location - b.location) || (b.level - a.level)); socket.emit('update_demolish_queue', { villageId, queue: uniqueTasks }); }
        function removeDemolishQueueItem(villageId, index) { const q = FULL_STATE.demolish_queues[villageId] || []; q.splice(index, 1); socket.emit('update_demolish_queue', { villageId, queue: q }); }
        function queueUpgradeTask(villageId, location, gid, levelInputElementId) { const levelInput = document.getElementById(levelInputElementId); addBuildTask(villageId, location, gid, levelInput.value); }
        function queueToMax(villageId, location, gid) { const villageQueue = FULL_STATE.build_queues[villageId] || []; const building = FULL_STATE.village_data[villageId].buildings.find(b => b.id == location); if (!building) return; const currentLevelInQueue = villageQueue.filter(q => q.location == location).reduce((maxLvl, q) => Math.max(maxLvl, q.level), building.level); const maxLevel = getMaxLevel(gid); if (currentLevelInQueue >= maxLevel) return; const newTasks = []; for (let level = currentLevelInQueue + 1; level <= maxLevel; level++) { newTasks.push({ type: 'building', location: parseInt(location), gid: parseInt(gid), level: level }); } socket.emit('update_build_queue', { villageId, queue: villageQueue.concat(newTasks) }); }
        function saveTemplate(villageId) { const nameInput = document.getElementById('template-name-input'); const templateName = nameInput.value.trim(); if (!templateName) return; socket.emit('save_build_template', { villageId, templateName }); nameInput.value = ''; }
        function loadTemplate(villageId) { const select = document.getElementById('template-select'); const templateName = select.value; if (!templateName) return; if (confirm(`This will overwrite the current build queue. Are you sure?`)) { socket.emit('load_build_template', { villageId, templateName }); } }
        function deleteTemplate() { const select = document.getElementById('template-select'); const templateName = select.value; if (!templateName) return; if (confirm(`Are you sure you want to delete the template "${templateName}"?`)) { socket.emit('delete_build_template', { templateName }); } }
        function formatDuration(seconds) { if (seconds <= 0) return "0:00:00"; const h = Math.floor(seconds / 3600); const m = Math.floor((seconds % 3600) / 60); const s = Math.floor(seconds % 60); return [h, m, s].map(v => v.toString().padStart(2, '0')).join(':'); }
        function is_multi_instance(gid) { return [10,11,23,36,38,39].includes(parseInt(gid)); }
    </script>
</body>
</html>
