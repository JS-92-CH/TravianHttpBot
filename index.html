<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travian Bot Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        :root{--bg-dark:#1a1a1a;--bg-light:#2c2c2c;--border-color:#444;--text-primary:#f0f0f0;--text-secondary:#a0a0a0;--accent-color:#00bfff;--btn-bg:#333;--btn-hover-bg:#444;--btn-danger-bg:#5c1a1a;--btn-danger-hover:#7d2a2a;--green:#28a745;--red:#dc3545}
        body{font-family:'Inter',sans-serif;background-color:var(--bg-dark);color:var(--text-primary);margin:0;padding:1rem;display:flex;flex-direction:column;height:100vh;box-sizing:border-box}
        h1,h2,h3,h4{font-weight:700;margin-top:0; color: var(--text-primary);}
        h1{color:var(--accent-color)}
        hr{border:1px solid var(--border-color); margin: 1.5rem 0;}
        button{background-color:var(--btn-bg);color:var(--text-primary);border:1px solid var(--border-color);padding:.5rem 1rem;border-radius:6px;cursor:pointer;transition:background-color .2s;font-weight:500}
        button:hover{background-color:var(--btn-hover-bg)}
        input,select,textarea{background-color:var(--bg-dark);color:var(--text-primary);border:1px solid var(--border-color);padding:.5rem;border-radius:6px;margin-bottom:.5rem;width:calc(100% - 1rem); font-family: 'Inter', sans-serif;}
        textarea { resize: vertical; min-height: 100px; }
        form{display:flex;flex-direction:column}
        table{width:100%;border-collapse:collapse;margin-top:1rem}
        th,td{padding:.75rem;text-align:left;border-bottom:1px solid var(--border-color)}
        th{font-weight:700;color:var(--text-secondary);text-transform: uppercase; font-size: 0.8em; letter-spacing: 0.5px;}
        .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;padding-bottom:1rem;border-bottom:2px solid var(--border-color)}
        #main-container{display:flex;flex-grow:1;gap:1rem;overflow:hidden}
        .panel{background-color:var(--bg-light);padding:1.5rem;border-radius:8px;overflow-y:auto; scrollbar-width: thin; scrollbar-color: var(--border-color) var(--bg-light);}
        #left-panel{flex:1;min-width:300px;display:flex;flex-direction:column;gap:1rem}
        #right-panel{flex:3;display:flex;flex-direction:column;gap:1rem}
        #village-details,#log-container{flex-shrink:0}
        #log{background-color:#111;padding:1rem;border-radius:6px;height:200px;overflow-y:scroll;font-family:monospace;font-size:.9em;flex-grow:1}
        .village-list-item{padding:.75rem;border-radius:6px;cursor:pointer;transition:background-color .2s;border:1px solid transparent}
        .village-list-item:hover{background-color:var(--btn-hover-bg)}
        .village-list-item.active{background-color:var(--accent-color);color:var(--bg-dark);font-weight:700;border-color:var(--accent-color)}
        .remove-btn{background:var(--btn-danger-bg);border-color:#8c3a3a;margin-left:1rem}
        .remove-btn:hover{background:var(--btn-danger-hover)}
        #account-list ul,#build-queue-list{list-style-type:none;padding:0}
        #account-list li,#build-queue-list li{display:flex;justify-content:space-between;align-items:center;padding:.5rem;border-radius:4px}
        #account-list li:nth-child(odd),#build-queue-list li:nth-child(odd){background-color:#333}
        .tabs{display:flex;border-bottom:1px solid var(--border-color);margin-bottom:1rem}
        .tab{padding:1rem;cursor:pointer;border-bottom:3px solid transparent}
        .tab.active{color:var(--accent-color);border-bottom:3px solid var(--accent-color);font-weight:700}
        .tab-content{display:none}
        .tab-content.active{display:block}
        .action-cell input { width: 60px; margin-right: 5px; }
        .action-cell button { padding: 0.4rem 0.6rem; margin-right: 5px;}
        .import-export-section { margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 1.5rem; }
    </style>
</head>
<body>
    <header class="header"><h1>Travian Bot Dashboard</h1><div class="controls"><button id="startBtn">Start Bot</button><button id="stopBtn">Stop Bot</button></div></header>
    <div id="main-container">
        <div id="left-panel" class="panel">
            <div><h2>Accounts</h2><div id="account-list"></div><hr><form id="add-account-form"><h3>Add New Account</h3><input type="text" id="username" placeholder="Username" required><input type="password" id="password" placeholder="Password" required><input type="text" id="server_url" placeholder="Server URL" required><button type="submit">Add Account</button></form></div>
            <div><h2>Villages</h2><div id="village-list"></div></div>
        </div>
        <div id="right-panel" class="panel">
            <div id="village-details"><p>Select a village to see details.</p></div>
            <div id="log-container" style="display:flex;flex-direction:column"><h2>Live Log</h2><div id="log"></div></div>
        </div>
    </div>
    <script>
        const socket = io();
        let FULL_STATE = {};
        const GID_MAP = {1:"Woodcutter",2:"Clay Pit",3:"Iron Mine",4:"Cropland",5:"Sawmill",6:"Brickyard",7:"Iron Foundry",8:"Grain Mill",9:"Bakery",10:"Warehouse",11:"Granary",13:"Smithy",14:"Tournament Square",15:"Main Building",16:"Rally Point",17:"Marketplace",18:"Embassy",19:"Barracks",20:"Stable",21:"Workshop",22:"Academy",23:"Cranny",24:"Town Hall",25:"Residence",26:"Palace",27:"Treasury",28:"Trade Office",29:"Great Barracks",30:"Great Stable",31:"City Wall",32:"Earth Wall",33:"Palisade",34:"Stonemason's Lodge",35:"Brewery",36:"Trapper",37:"Hero's Mansion",38:"Great Warehouse",39:"Great Granary",40:"Wonder of the World",41:"Horse Drinking Trough",42:"Stone Wall",43:"Makeshift Wall",44:"Command Center",45:"Waterworks",46:"Hospital"};
        const SINGLE_INSTANCE_GIDS = [13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 40, 41, 42, 43, 44, 45, 46];

        let selectedVillageId = null;
        let activeTabs = {}; // Store active tab per village

        socket.on('connect', () => document.querySelector('#log').innerHTML += '<p style="color:var(--green)">Dashboard connected.</p>');
        socket.on('log_message', msg => {
            const log = document.getElementById('log');
            log.innerHTML += msg.data.replace(/</g, "&lt;").replace(/>/g, "&gt;") + '<br>';
            log.scrollTop = log.scrollHeight;
        });

        socket.on('state_update', newState => {
            FULL_STATE = newState;
            renderAccountsAndVillages();
            if(selectedVillageId) {
                showVillageDetails(selectedVillageId);
            }
        });

        function renderAccountsAndVillages() {
            const accList = document.getElementById('account-list');
            if (accList) accList.innerHTML = '<ul>' + (FULL_STATE.accounts || []).map(acc => `<li><span>${acc.username}</span> <button class="remove-btn" onclick="removeAccount('${acc.username}')">X</button></li>`).join('') + '</ul>';

            const villageList = document.getElementById('village-list');
            if (villageList) {
                let currentListHTML = villageList.innerHTML;
                let newListHTML = '';
                let activeVillageFound = false;
                for (const username in FULL_STATE.village_data) {
                    if (isNaN(parseInt(username))) {
                         const villageData = FULL_STATE.village_data[username];
                        if (Array.isArray(villageData)) {
                            villageData.forEach(village => {
                                const activeClass = village.id == selectedVillageId ? 'active' : '';
                                if(village.id == selectedVillageId) activeVillageFound = true;
                                newListHTML += `<div class="village-list-item ${activeClass}" id="village-item-${village.id}" onclick="showVillageDetails('${village.id}')">${village.name}</div>`;
                            });
                        }
                    }
                }
                if (currentListHTML !== newListHTML) {
                    villageList.innerHTML = newListHTML;
                }
                if (!activeVillageFound) selectedVillageId = null;
            }
        }
        
        function getMaxLevel(gid) {
            gid = parseInt(gid);
            if (gid === 40) return 100; // Wonder of the World
            if (gid === 23) return 10;  // Cranny
            // Buildings with max level 5
            if ([5, 6, 7, 8, 9].includes(gid)) return 5;
            return 20; // Default max level
        }

        function addBuildTask(villageId, location, gid, level, isMax = false) {
            const maxLevel = getMaxLevel(gid);
            const targetLevel = isMax ? maxLevel : parseInt(level);
            
            if (isNaN(targetLevel) || targetLevel <= 0) {
                alert("Invalid level specified.");
                return;
            }
            const currentBuilding = FULL_STATE.village_data[villageId].buildings.find(b => b.id == location);
            if (currentBuilding && targetLevel <= currentBuilding.level) {
                alert(`Target level must be higher than current level (${currentBuilding.level}).`);
                return;
            }

            const task = {
                type: 'building',
                location: parseInt(location),
                gid: parseInt(gid),
                level: targetLevel
            };
            
            socket.emit('add_build_task', { villageId: villageId, task: task });
        }
        
        function addNewBuildingTask(villageId, location, selectElementId, levelInputElementId) {
            const select = document.getElementById(selectElementId);
            const levelInput = document.getElementById(levelInputElementId);
            
            const gid = select.value;
            const level = levelInput.value;

            if (!gid || gid === "0") {
                alert("Please select a building type.");
                return;
            }
            addBuildTask(villageId, location, gid, level, false);
        }

        function showVillageDetails(villageId) {
            if (!villageId) {
                selectedVillageId = null;
                document.getElementById('village-details').innerHTML = '<p>Select a village to see details.</p>';
                return;
            }
            selectedVillageId = villageId;
            document.querySelectorAll('.village-list-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`village-item-${villageId}`)?.classList.add('active');

            const villageData = FULL_STATE.village_data[villageId];
            const villageQueue = FULL_STATE.build_queues[villageId] || [];
            const detailsDiv = document.getElementById('village-details');
            
            if (!villageData || !villageData.resources || !villageData.buildings) {
                detailsDiv.innerHTML = `<h2>Details for Village ${villageId}</h2><p>Waiting for data from agent...</p>`;
                return;
            }
            
            let villageName = "Unknown";
            for (const username in FULL_STATE.village_data) {
                if (isNaN(parseInt(username)) && Array.isArray(FULL_STATE.village_data[username])) {
                    const found = FULL_STATE.village_data[username].find(v => v.id == villageId);
                    if (found) { villageName = found.name; break; }
                }
            }
            
            const tribe = villageData.tribe || 'unknown';

            let html = `<h2>Village: ${villageName} (ID: ${villageId}) <span style="text-transform: capitalize; font-size: 0.8em; color: var(--text-secondary);">- ${tribe}</span></h2>`;
            html += '<h3>Resources</h3><table><thead><tr><th>Resource</th><th>Current</th><th>Storage</th><th>Production/hr</th></tr></thead><tbody>';
            html += `<tr><td>Wood</td><td>${Math.floor(villageData.resources.l1) || 0}</td><td>${villageData.storage.l1 || 0}</td><td>${villageData.production.l1 || 0}</td></tr>`;
            html += `<tr><td>Clay</td><td>${Math.floor(villageData.resources.l2) || 0}</td><td>${villageData.storage.l2 || 0}</td><td>${villageData.production.l2 || 0}</td></tr>`;
            html += `<tr><td>Iron</td><td>${Math.floor(villageData.resources.l3) || 0}</td><td>${villageData.storage.l3 || 0}</td><td>${villageData.production.l3 || 0}</td></tr>`;
            html += `<tr><td>Crop</td><td>${Math.floor(villageData.resources.l4) || 0}</td><td>${villageData.storage.l4 || 0}</td><td>${villageData.production.l4 || 0}</td></tr></tbody></table>`;

            const currentTab = activeTabs[villageId] || 'fields';
            html += `<div class="tabs">
                <div class="tab ${currentTab === 'fields' ? 'active' : ''}" onclick="openTab(event, 'fields', '${villageId}')">Resource Fields</div>
                <div class="tab ${currentTab === 'buildings' ? 'active' : ''}" onclick="openTab(event, 'buildings', '${villageId}')">City Buildings</div>
                <div class="tab ${currentTab === 'new' ? 'active' : ''}" onclick="openTab(event, 'new', '${villageId}')">New Build</div>
            </div>`;
            
            // --- Resource Fields Tab ---
            html += `<div id="fields" class="tab-content ${currentTab === 'fields' ? 'active' : ''}"><h4>Resource Fields</h4><table><thead><tr><th>Location</th><th>Name</th><th>Level</th><th>Actions</th></tr></thead><tbody>`;
            villageData.buildings.filter(b => b.id <= 18).sort((a,b) => a.id - b.id).forEach(b => {
                const maxLvl = getMaxLevel(b.gid);
                html += `<tr><td>${b.id}</td><td>${GID_MAP[b.gid] || `GID ${b.gid}`}</td><td>${b.level}</td><td class="action-cell">
                    <input type="number" id="level-input-${villageId}-${b.id}" min="${b.level + 1}" max="${maxLvl}" value="${b.level + 1}" ${b.level >= maxLvl ? 'disabled' : ''}>
                    <button onclick="addBuildTask('${villageId}', '${b.id}', '${b.gid}', document.getElementById('level-input-${villageId}-${b.id}').value)" ${b.level >= maxLvl ? 'disabled' : ''}>+</button>
                    <button onclick="addBuildTask('${villageId}', '${b.id}', '${b.gid}', 0, true)" ${b.level >= maxLvl ? 'disabled' : ''}>Max</button>
                </td></tr>`;
            });
            html += '</tbody></table></div>';

            // --- City Buildings Tab ---
            html += `<div id="buildings" class="tab-content ${currentTab === 'buildings' ? 'active' : ''}"><h4>City Buildings</h4><table><thead><tr><th>Location</th><th>Name</th><th>Level</th><th>Actions</th></tr></thead><tbody>`;
            villageData.buildings.filter(b => b.id > 18 && b.gid > 0).sort((a,b) => a.id - b.id).forEach(b => {
                const maxLvl = getMaxLevel(b.gid);
                html += `<tr><td>${b.id}</td><td>${GID_MAP[b.gid] || `GID ${b.gid}`}</td><td>${b.level}</td><td class="action-cell">
                    <input type="number" id="level-input-${villageId}-${b.id}" min="${b.level + 1}" max="${maxLvl}" value="${b.level + 1}" ${b.level >= maxLvl ? 'disabled' : ''}>
                    <button onclick="addBuildTask('${villageId}', '${b.id}', '${b.gid}', document.getElementById('level-input-${villageId}-${b.id}').value)" ${b.level >= maxLvl ? 'disabled' : ''}>+</button>
                    <button onclick="addBuildTask('${villageId}', '${b.id}', '${b.gid}', 0, true)" ${b.level >= maxLvl ? 'disabled' : ''}>Max</button>
                </td></tr>`;
            });
            html += '</tbody></table></div>';
            
            // --- New Build Tab ---
            const existingGIDs = villageData.buildings.map(b => b.gid);
            const buildableGIDs = Object.keys(GID_MAP)
                .map(gid => parseInt(gid))
                .filter(gid => gid >= 5 && gid <= 46) // Filter for only buildable buildings
                .filter(gid => !(SINGLE_INSTANCE_GIDS.includes(gid) && existingGIDs.includes(gid)));

            let optionsHtml = '<option value="0">-- Select Building --</option>';
            buildableGIDs.sort((a,b) => GID_MAP[a].localeCompare(GID_MAP[b])).forEach(gid => optionsHtml += `<option value="${gid}">${GID_MAP[gid]}</option>`);

            html += `<div id="new" class="tab-content ${currentTab === 'new' ? 'active' : ''}"><h4>Build in Empty Slot</h4><table><thead><tr><th>Location</th><th>Building</th><th>Target Level</th><th>Action</th></tr></thead><tbody>`;
            villageData.buildings.filter(b => b.id > 18 && b.gid === 0).forEach(slot => {
                let slotOptions = optionsHtml;
                // Special handling for wall slot 40
                if (slot.id == 40) {
                    const wallMap = {'roman': 31, 'teuton': 32, 'gaul': 33, 'egyptian': 42, 'hun': 43};
                    const wallGid = wallMap[tribe];
                    if (wallGid && !existingGIDs.includes(wallGid)) {
                         slotOptions = `<option value="${wallGid}">${GID_MAP[wallGid]}</option>`;
                    } else {
                        slotOptions = `<option value="0">Wall already built</option>`;
                    }
                }

                html += `<tr>
                    <td>${slot.id}</td>
                    <td><select id="gid-select-${villageId}-${slot.id}">${slotOptions}</select></td>
                    <td><input type="number" id="level-input-new-${villageId}-${slot.id}" min="1" max="20" value="1" style="width: 80px;"></td>
                    <td><button onclick="addNewBuildingTask('${villageId}', '${slot.id}', 'gid-select-${villageId}-${slot.id}', 'level-input-new-${villageId}-${slot.id}')">Add to Queue</button></td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            
            // --- Build Queue & Import/Export ---
            html += `<h3>Build Queue (${villageQueue.length})</h3><ol id="build-queue-list">`;
            villageQueue.forEach((job, index) => {
                const jobName = job.gid ? `${GID_MAP[job.gid] || 'Unknown'} (Loc: ${job.location})` : `Task ${job.type}`;
                html += `<li><span>${jobName} to Level ${job.level}</span> <button class="remove-btn" onclick="removeQueueItem('${villageId}', ${index})">X</button></li>`;
            });
            html += '</ol>';

            html += `<div class="import-export-section">
                <h4>Import / Export Queue</h4>
                <button onclick="exportQueue('${villageId}')">Export Queue</button>
                <hr>
                <textarea id="import-json-area" placeholder="Paste JSON build queue here..."></textarea>
                <button onclick="importQueue('${villageId}')">Import and Replace Queue</button>
            </div>`;

            detailsDiv.innerHTML = html;
        }

        function openTab(event, tabName, villageId) {
            activeTabs[villageId] = tabName;
            const parent = event.currentTarget.closest('#village-details');
            parent.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
            parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            parent.querySelector(`#${tabName}`).style.display = 'block';
            event.currentTarget.classList.add('active');
        }

        function exportQueue(villageId) {
            const queue = FULL_STATE.build_queues[villageId] || [];
            const exportData = queue.map((task, index) => {
                const content = JSON.stringify({
                    Location: task.location,
                    Level: task.level,
                    Type: task.gid
                });
                return {
                    Id: { Value: 0 },
                    Position: index,
                    Type: 0, // Assuming type 0 for building tasks
                    Content: content
                };
            });
            const jsonString = JSON.stringify(exportData, null, 2);
            const importArea = document.getElementById('import-json-area');
            importArea.value = jsonString;
            alert('Queue exported to the text area below.');
        }

        function importQueue(villageId) {
            const jsonString = document.getElementById('import-json-area').value;
            if (!jsonString) {
                alert('Paste a JSON queue into the text area first.');
                return;
            }
            try {
                const importData = JSON.parse(jsonString);
                if (!Array.isArray(importData)) {
                    throw new Error("Input is not a JSON array.");
                }

                const newQueue = importData.map(item => {
                    if (item.Type === 0 && item.Content) {
                        const content = JSON.parse(item.Content);
                        return {
                            type: 'building',
                            location: parseInt(content.Location),
                            gid: parseInt(content.Type),
                            level: parseInt(content.Level)
                        };
                    }
                    return null;
                }).filter(task => task !== null);

                if (confirm(`This will replace the current queue for this village with ${newQueue.length} new tasks. Are you sure?`)) {
                    socket.emit('update_build_queue', { villageId: villageId, queue: newQueue });
                }
            } catch (e) {
                alert('Error parsing JSON. Please check the format.\n' + e.message);
            }
        }


        document.getElementById('startBtn').onclick = () => socket.emit('start_bot');
        document.getElementById('stopBtn').onclick = () => socket.emit('stop_bot');
        document.getElementById('add-account-form').onsubmit = (e) => {
            e.preventDefault();
            socket.emit('add_account', { username: document.getElementById('username').value, password: document.getElementById('password').value, server_url: document.getElementById('server_url').value });
            e.target.reset();
        };

        function removeAccount(username) {
            if(confirm(`Are you sure you want to remove account: ${username}?`)) {
                socket.emit('remove_account', {username});
            }
        }
        function removeQueueItem(villageId, index) {
           const currentQueue = FULL_STATE.build_queues[villageId] || [];
           currentQueue.splice(index, 1);
           socket.emit('update_build_queue', { villageId: villageId, queue: currentQueue });
        }
    </script>
</body>
</html>