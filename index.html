<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travian Bot Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        :root {
            --bg-primary: #1e1e2e;
            --bg-secondary: #27293d;
            --bg-tertiary: #3b3e58;
            --text-primary: #f8f8f2;
            --text-secondary: #bd93f9;
            --text-muted: #6272a4;
            --accent-primary: #50fa7b;
            --accent-secondary: #ff79c6;
            --accent-highlight: #f1fa8c;
            --border-color: #44475a;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 1.5rem;
            box-sizing: border-box;
        }

        .container {
            display: flex;
            gap: 1.5rem;
            height: calc(100vh - 3rem);
        }

        .column {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        #left-column { flex: 1; min-width: 300px; }
        #middle-column { flex: 1; min-width: 300px; }
        #right-column { flex: 2; min-width: 450px; }

        .card {
            background-color: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        #village-details-card, #log-card {
             flex-grow: 1;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-secondary);
            margin: 0;
        }
        
        .card-content {
            padding: 1.5rem;
            overflow-y: auto;
            transition: all 0.3s ease-in-out;
        }
        
        .card-content.collapsed {
            display: none;
        }

        .btn {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
        }

        .btn:hover { background-color: #44475a; }
        .btn-primary { background-color: var(--accent-primary); color: var(--bg-primary); }
        .btn-danger { background-color: var(--accent-secondary); color: var(--bg-primary); }

        .form-group { margin-bottom: 1rem; }
        .form-control {
            width: 100%;
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 0.75rem;
            border-radius: 6px;
            box-sizing: border-box;
        }

        .village-list { list-style: none; padding: 0; margin: 0; }
        .village-list-item {
            padding: 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid var(--border-color);
        }
        .village-list-item:hover { background-color: var(--bg-tertiary); }
        .village-list-item.active { background-color: var(--text-secondary); color: var(--bg-primary); font-weight: 700; }

        #log {
            background-color: #111;
            padding: 1rem;
            border-radius: 6px;
            height: 100%;
            overflow-y: scroll;
            font-family: monospace;
            font-size: 0.9em;
            box-sizing: border-box;
        }
        
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { font-weight: 700; color: var(--text-secondary); }
        
        .upgradeable {
             background-color: rgba(241, 250, 140, 0.1);
        }
        .upgradeable:hover {
            background-color: rgba(241, 250, 140, 0.2);
        }

        .tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 1rem; }
        .tab { padding: 1rem; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab.active { color: var(--accent-primary); border-bottom: 3px solid var(--accent-primary); font-weight: 700; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .resource-upgrade-form{
            display:flex;
            align-items:center;
            gap:10px;padding:1rem;
            background-color:var(--bg-tertiary);
            border-radius:6px;
            margin-top:1rem;
        }

    </style>
</head>
<body>
    <div class="container">
        <div id="left-column" class="column">
            <div class="card">
                <div class="card-header" onclick="toggleCollapse('controls-content')">
                    <h2 class="card-title">Controls</h2>
                </div>
                <div id="controls-content" class="card-content">
                    <div style="display: flex; gap: 1rem;">
                        <button id="startBtn" class="btn btn-primary">Start Bot</button>
                        <button id="stopBtn" class="btn btn-danger">Stop Bot</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header" onclick="toggleCollapse('accounts-content')">
                    <h2 class="card-title">Accounts</h2>
                </div>
                <div id="accounts-content" class="card-content">
                    <div id="account-list"></div>
                    <hr style="border-color: var(--border-color); margin: 1.5rem 0;">
                    <h3 style="color: var(--text-secondary);">Add New Account</h3>
                    <form id="add-account-form">
                        <div class="form-group"><input type="text" id="username" class="form-control" placeholder="Username" required></div>
                        <div class="form-group"><input type="password" id="password" class="form-control" placeholder="Password" required></div>
                        <div class="form-group"><input type="text" id="server_url" class="form-control" placeholder="Server URL" required></div>
                        <div class="form-group"><label><input type="checkbox" id="use_dual_queue"> Use Plus Account (2 builds)</label></div>
                        <div class="form-group"><label><input type="checkbox" id="use_hero_resources"> Use Hero Resources</label></div>
                        <hr style="border-color: var(--border-color); margin: 1.5rem 0;">
                        <h4 style="color: var(--text-secondary);">Proxy (Optional)</h4>
                        <div class="form-group"><input type="text" id="proxy_ip" class="form-control" placeholder="Proxy IP/Host"></div>
                        <div class="form-group"><input type="text" id="proxy_port" class="form-control" placeholder="Proxy Port"></div>
                        <div class="form-group"><input type="text" id="proxy_user" class="form-control" placeholder="Proxy Username"></div>
                        <div class="form-group"><input type="password" id="proxy_pass" class="form-control" placeholder="Proxy Password"></div>
                        <button type="submit" class="btn" style="width: 100%;">Add Account</button>
                    </form>
                </div>
            </div>
             <div class="card" id="log-card">
                <div class="card-header" onclick="toggleCollapse('log-content')">
                    <h2 class="card-title">Live Log</h2>
                </div>
                <div id="log-content" class="card-content">
                    <div id="log"></div>
                </div>
            </div>
        </div>

        <div id="middle-column" class="column">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Villages</h2>
                </div>
                <div class="card-content">
                    <ul id="village-list" class="village-list"></ul>
                </div>
            </div>
        </div>

        <div id="right-column" class="column">
            <div class="card" id="village-details-card">
                <div class="card-header">
                    <h2 class="card-title">Village Details</h2>
                </div>
                <div id="village-details" class="card-content">
                    <p>Select a village to see details.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let FULL_STATE = {};
        const GID_MAP = {1:"Woodcutter",2:"Clay Pit",3:"Iron Mine",4:"Cropland",5:"Sawmill",6:"Brickyard",7:"Iron Foundry",8:"Grain Mill",9:"Bakery",10:"Warehouse",11:"Granary",13:"Smithy",14:"Tournament Square",15:"Main Building",16:"Rally Point",17:"Marketplace",18:"Embassy",19:"Barracks",20:"Stable",21:"Workshop",22:"Academy",23:"Cranny",24:"Town Hall",25:"Residence",26:"Palace",27:"Treasury",28:"Trade Office",29:"Great Barracks",30:"Great Stable",31:"City Wall",32:"Earth Wall",33:"Palisade",34:"Stonemason's Lodge",35:"Brewery",36:"Trapper",37:"Hero's Mansion",38:"Great Warehouse",39:"Great Granary",40:"Wonder of the World",41:"Horse Drinking Trough",42:"Stone Wall",43:"Makeshift Wall",44:"Command Center",45:"Waterworks",46:"Hospital"};
        let selectedVillageId = null;
        let currentTab = 'fields';

        function toggleCollapse(contentId) {
            document.getElementById(contentId).classList.toggle('collapsed');
        }

        function isMultiInstance(gid) {
            gid = parseInt(gid);
            return [10,11,23,36,38,39].includes(gid);
        }

        socket.on('connect', () => {
            const log = document.getElementById('log');
            if(log) log.innerHTML += '<p style="color:var(--accent-primary)">Dashboard connected.</p>';
        });

        socket.on('log_message', msg => {
            const log = document.getElementById('log');
            if(log) {
                log.innerHTML += msg.data.replace(/</g, "&lt;").replace(/>/g, "&gt;") + '<br>';
                log.scrollTop = log.scrollHeight;
            }
        });

        socket.on('state_update', newState => {
            FULL_STATE = newState;
            renderAccountsAndVillages();
            if(selectedVillageId) {
                showVillageDetails(selectedVillageId);
            }
        });

        function renderAccountsAndVillages() {
            const accList = document.getElementById('account-list');
            if (accList) {
                let html = '<ul style="padding:0; margin:0; list-style:none;">';
                (FULL_STATE.accounts || []).forEach(acc => {
                    const proxy_info = acc.proxy && acc.proxy.ip ? ` <small style="color:var(--text-muted);">(Proxy: ${acc.proxy.ip})</small>` : '';
                    html += `
                        <li style="background-color: var(--bg-tertiary); padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <input type="checkbox" onchange="updateAccount('${acc.username}', 'use_dual_queue', this.checked)" ${acc.use_dual_queue ? 'checked' : ''} title="Use Plus Account (2 builds)">
                                <input type="checkbox" onchange="updateAccount('${acc.username}', 'use_hero_resources', this.checked)" ${acc.use_hero_resources ? 'checked' : ''} title="Use Hero Resources">
                                ${acc.username} ${proxy_info}
                            </div>
                            <button class="btn" style="background-color: var(--accent-secondary); color: var(--bg-primary); padding: 0.2rem 0.5rem;" onclick="removeAccount('${acc.username}')">X</button>
                        </li>
                    `;
                });
                html += '</ul>';
                accList.innerHTML = html;
            }

            const villageList = document.getElementById('village-list');
            if (villageList) {
                villageList.innerHTML = '';
                let activeVillageFound = false;
                for (const username in FULL_STATE.village_data) {
                    if (isNaN(parseInt(username))) {
                         const villageData = FULL_STATE.village_data[username];
                        if (Array.isArray(villageData)) {
                            villageData.forEach(village => {
                                const activeClass = village.id == selectedVillageId ? 'active' : '';
                                if(village.id == selectedVillageId) activeVillageFound = true;
                                villageList.innerHTML += `<li class="village-list-item ${activeClass}" id="village-item-${village.id}" onclick="showVillageDetails('${village.id}')">${village.name}</li>`;
                            });
                        }
                    }
                }
                if (!activeVillageFound) selectedVillageId = null;
            }
        }
        
        function getMaxLevel(gid) {
            gid = parseInt(gid);
            if ([1,2,3,4].includes(gid)) {
                 return 10;
            }
            if (gid === 40) return 100; // Wonder of the World
            if (gid === 23) return 10; // Cranny
            if ([5,6,7,8,9].includes(gid)) return 5; // Resource boosters
            return 20; // Default for most buildings
        }

        function getWallGid(villageData) {
            const wallGids = [31,32,33,42,43];
            const slot40 = villageData.buildings.find(b => b.id === 40 && wallGids.includes(b.gid));
            if (slot40) return slot40.gid;
            const existing = villageData.buildings.find(b => wallGids.includes(b.gid));
            if (existing) return existing.gid;
            return 31; // Default to Roman wall
        }

        function addBuildTask(villageId, location, gid, level, isMax = false) {
            const maxLevel = getMaxLevel(gid);
            const targetLevel = isMax ? maxLevel : parseInt(level);
            
            if (isNaN(targetLevel) || targetLevel <= 0) {
                alert("Invalid level specified."); return;
            }
            if (targetLevel > maxLevel) {
                 alert(`Level cannot exceed ${maxLevel} for this building.`); return;
            }
            const task = { type: 'building', location: parseInt(location), gid: parseInt(gid), level: targetLevel };
            
            socket.emit('add_build_task', { villageId: villageId, task: task });
        }

        function upgradeAllResources(villageId) {
            const targetLevelInput = document.getElementById(`resource-target-level-${villageId}`);
            const targetLevel = parseInt(targetLevelInput.value);
            if (isNaN(targetLevel) || targetLevel < 1 || targetLevel > 10) {
                alert('Please enter a valid target level (1-10).');
                return;
            }

            const task = { type: 'resource_plan', level: targetLevel };
            let currentQueue = FULL_STATE.build_queues[villageId] || [];
            
            currentQueue.push(task);
            
            socket.emit('update_build_queue', { villageId: villageId, queue: currentQueue });
            alert(`Added 'All Resources to Level ${targetLevel}' to the queue.`);
        }


        function addNewBuildingTask(villageId, location, selectElementId, levelInputElementId) {
            const select = document.getElementById(selectElementId);
            const levelInput = document.getElementById(levelInputElementId);
            const gid = select.value;
            const level = levelInput.value;
            if (!gid || gid === "0") {
                alert("Please select a building type."); return;
            }
            addBuildTask(villageId, location, gid, level, false);
        }

        function showVillageDetails(villageId) {
            selectedVillageId = villageId;
            const detailsDiv = document.getElementById('village-details');
            if (!detailsDiv) return;

            document.querySelectorAll('.village-list-item').forEach(el => el.classList.remove('active'));
            const villageItem = document.getElementById(`village-item-${villageId}`);
            if(villageItem) villageItem.classList.add('active');

            const villageData = FULL_STATE.village_data[villageId];
            if (!villageData || !villageData.resources || !villageData.buildings) {
                detailsDiv.innerHTML = `<p>Waiting for data from agent...</p>`;
                return;
            }

            const villageQueue = FULL_STATE.build_queues[villageId] || [];
            const trainingDataForVillage = FULL_STATE.training_data ? FULL_STATE.training_data[villageId] : {};
            const trainingSettingsForVillage = FULL_STATE.training_queues ? FULL_STATE.training_queues[villageId] : {};
            
            const projectedBuildings = JSON.parse(JSON.stringify(villageData.buildings));
            const projectedBuildingMap = new Map(projectedBuildings.map(b => [b.id, b]));

            villageQueue.forEach(task => {
                if (task.type === 'building' && task.location) {
                    const buildingAtLocation = projectedBuildingMap.get(task.location);
                    if (buildingAtLocation && buildingAtLocation.gid === 0) {
                        buildingAtLocation.gid = task.gid;
                        buildingAtLocation.name = GID_MAP[task.gid] || `GID ${task.gid}`;
                    }
                }
            });

            let resourcesHtml = `<h3>Resources</h3><table><thead><tr><th>Resource</th><th>Current</th><th>Storage</th><th>Production/hr</th></tr></thead><tbody>`;
            resourcesHtml += `<tr><td>Wood</td><td>${Math.floor(villageData.resources.l1) || 0}</td><td>${villageData.storage.l1 || 0}</td><td>${villageData.production.l1 || 0}</td></tr>`;
            resourcesHtml += `<tr><td>Clay</td><td>${Math.floor(villageData.resources.l2) || 0}</td><td>${villageData.storage.l2 || 0}</td><td>${villageData.production.l2 || 0}</td></tr>`;
            resourcesHtml += `<tr><td>Iron</td><td>${Math.floor(villageData.resources.l3) || 0}</td><td>${villageData.storage.l3 || 0}</td><td>${villageData.production.l3 || 0}</td></tr>`;
            resourcesHtml += `<tr><td>Crop</td><td>${Math.floor(villageData.resources.l4) || 0}</td><td>${villageData.storage.l4 || 0}</td><td>${villageData.production.l4 || 0}</td></tr></tbody></table>`;

            let tabsHtml = '<div class="tabs">'
                 + '<div class="tab" id="tab-fields" onclick="openTab(event, \'fields\')">Resource Fields</div>'
                 + '<div class="tab" id="tab-buildings" onclick="openTab(event, \'buildings\')">City Buildings</div>'
                 + '<div class="tab" id="tab-training" onclick="openTab(event, \'training\')">Training</div>'
                 + '<div class="tab" id="tab-new" onclick="openTab(event, \'new\')">New Build</div>'
                 + '</div>';

            function getActionControls(villageId, building) {
                const currentLevelInQueue = villageQueue.filter(q => q.location === building.id).reduce((maxLvl, q) => Math.max(maxLvl, q.level), building.level);
                const maxLvl = getMaxLevel(building.gid);
                const isUpgradeable = currentLevelInQueue < maxLvl;
                const nextLevel = currentLevelInQueue + 1;

                if (!isUpgradeable) {
                    return `<button class="btn" disabled>Max Level</button>`;
                }

                return `<div style="display:flex; align-items:center; gap: 10px;">
                            <input type="number" id="level-input-${villageId}-${building.id}" class="form-control" min="${nextLevel}" max="${maxLvl}" value="${nextLevel}" style="width: 80px;">
                            <button onclick="queueUpgradeTask('${villageId}', '${building.id}', '${building.gid}', 'level-input-${villageId}-${building.id}')" class="btn">Queue</button>
                            <button onclick="queueToMax('${villageId}', '${building.id}', '${building.gid}')" class="btn" style="background-color: var(--accent-highlight); color: var(--bg-primary);">Max</button>
                        </div>`;
            }

            let fieldsContent = '<div id="fields" class="tab-content">';
            fieldsContent += `<div class="resource-upgrade-form">
                                 <label for="resource-target-level-${villageId}">Set Resource Plan Target Level:</label>
                                 <input type="number" id="resource-target-level-${villageId}" value="10" min="1" max="10" style="width: 80px;">
                                 <button onclick="upgradeAllResources('${villageId}')">Set Plan</button>
                               </div>`;
            fieldsContent += '<table><thead><tr><th>Location</th><th>Name</th><th>Level</th><th>Actions</th></tr></thead><tbody>';
            projectedBuildings.filter(b => b.id <= 18).sort((a,b) => a.id - b.id).forEach(b => {
                const rowClass = villageQueue.some(q => q.location === b.id) ? '' : 'upgradeable';
                fieldsContent += `<tr class="${rowClass}"><td>${b.id}</td><td>${GID_MAP[b.gid] || `GID ${b.gid}`}</td><td>${b.level}</td><td>${getActionControls(villageId, b)}</td></tr>`;
            });
            fieldsContent += '</tbody></table></div>';
            
            let buildingsContent = '<div id="buildings" class="tab-content"><table><thead><tr><th>Location</th><th>Name</th><th>Level</th><th>Actions</th></tr></thead><tbody>';
            projectedBuildings.filter(b => b.id > 18 && b.gid > 0).sort((a,b) => a.id - b.id).forEach(b => {
                const rowClass = villageQueue.some(q => q.location === b.id) ? '' : 'upgradeable';
                buildingsContent += `<tr class="${rowClass}"><td>${b.id}</td><td>${b.name || GID_MAP[b.gid] || `GID ${b.gid}`}</td><td>${b.level}</td><td>${getActionControls(villageId, b)}</td></tr>`;
            });
            buildingsContent += '</tbody></table></div>';
            
            let trainingContent = '<div id="training" class="tab-content"><h3>Troop Training Configuration</h3>';
            if (!trainingDataForVillage || Object.keys(trainingDataForVillage).length === 0) {
                trainingContent += '<p>Waiting for training data from the bot...</p>';
            } else {
                let hasAnyTrainableUnits = false;
                Object.keys(trainingDataForVillage).forEach(buildingType => {
                    const buildingInfo = trainingDataForVillage[buildingType];
                    const trainableUnits = buildingInfo.trainable || [];
                    if (trainableUnits.length > 0) {
                        hasAnyTrainableUnits = true;
                        const currentSettings = trainingSettingsForVillage[buildingType] || {};
                        trainingContent += `<div class="card" style="margin-top: 1rem; border: 1px solid var(--text-muted);">
                            <div class="card-header" style="padding: 0.8rem 1.2rem;"><h4 class="card-title" style="font-size: 1.1rem; color: var(--text-primary);">${buildingType}</h4></div>
                            <div class="card-content" style="padding: 1.2rem;">
                                <div class="form-group">
                                    <label style="display:block; margin-bottom: 0.5rem;">Troop to Train:</label>
                                    <select id="train-select-${villageId}-${buildingType}" class="form-control">
                                        <option value="">-- Do Not Train --</option>
                                        ${trainableUnits.map(unit => `<option value="${unit.name}" ${unit.name === currentSettings.troop_name ? 'selected' : ''}>${unit.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label style="display:block; margin-bottom: 0.5rem;">Queue for at least (minutes):</label>
                                    <input type="number" id="train-duration-${villageId}-${buildingType}" class="form-control" min="0" value="${currentSettings.queue_duration_minutes || 0}">
                                </div>
                            </div>
                        </div>`;
                    }
                });
                if (hasAnyTrainableUnits) {
                    trainingContent += `<button onclick="saveTrainingSettings('${villageId}')" class="btn btn-primary" style="margin-top: 1rem;">Save Training Settings</button>`;
                } else {
                    trainingContent += '<p>No troops have been researched in this village yet.</p>';
                }
            }
            trainingContent += '</div>';

            let newBuildContent = '<div id="new" class="tab-content"><h4>Build in Empty Slot</h4><table><thead><tr><th>Location</th><th>Action</th></tr></thead><tbody>';
            const baseBuildable = [5,6,7,8,9,10,11,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46];
            const existingUniqueGids = new Set(projectedBuildings.filter(b => b.gid > 0 && !isMultiInstance(b.gid)).map(b => b.gid));
            const buildableGIDs = baseBuildable.filter(g => !existingUniqueGids.has(g));
            villageData.buildings.filter(b => b.id > 18 && b.gid === 0).forEach(slot => {
                const queuedBuilding = villageQueue.find(q => q.location === slot.id);
                if (!queuedBuilding) {
                    newBuildContent += `<tr><td>${slot.id}</td><td>`;
                    let allowedGIDs = buildableGIDs.slice();
                    if (slot.id === 40) allowedGIDs = [getWallGid(villageData)];
                    else if (slot.id === 39) allowedGIDs = [16];
                    
                    let optionsHtml = '<option value="0">-- Select Building --</option>' + allowedGIDs.map(gid => `<option value="${gid}">${GID_MAP[gid]}</option>`).join('');
                    newBuildContent += `<div style="display:flex; align-items:center; gap: 10px;">
                        <select id="gid-select-${villageId}-${slot.id}" class="form-control" style="width: auto;">${optionsHtml}</select>
                        <input type="number" id="level-input-new-${villageId}-${slot.id}" class="form-control" min="1" max="20" value="1" style="width: 80px;">
                        <button onclick="addNewBuildingTask('${villageId}', '${slot.id}', 'gid-select-${villageId}-${slot.id}', 'level-input-new-${villageId}-${slot.id}')" class="btn">Queue</button>
                    </div>`;
                    newBuildContent += '</td></tr>';
                }
            });
            newBuildContent += '</tbody></table></div>';
            
            // --- START: MODIFIED QUEUE CONTROLS ---
            let queueHtml = `<h3 style="margin-top: 2rem;">Build Queue (${villageQueue.length})</h3>
                             <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                 <button onclick="exportQueue('${villageId}')" class="btn">Export</button>
                                 <button onclick="importQueue('${villageId}')" class="btn">Import</button>
                                 <button onclick="importOffVillageQueue('${villageId}')" class="btn btn-primary">Load Off Village</button>
                             </div>`;
            // --- END: MODIFIED QUEUE CONTROLS ---

            queueHtml += `<ol id="build-queue-list" style="list-style-type: none; padding: 0;">`;
            villageQueue.forEach((job, index) => {
                let jobName = (job.type === 'resource_plan') ? `ALL RESOURCES PLAN` : `${GID_MAP[job.gid] || 'Unknown'} (Loc: ${job.location})`;
                queueHtml += `<li style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-radius: 4px; background-color: var(--bg-tertiary); margin-bottom: 0.5rem;">
                            <span>${index + 1}. ${jobName} to Level ${job.level}</span>
                            <div>
                                <button class="btn" onclick="moveQueueItem('${villageId}', ${index}, 'top')">Top</button>
                                <button class="btn" onclick="moveQueueItem('${villageId}', ${index}, 'up')">Up</button>
                                <button class="btn" onclick="moveQueueItem('${villageId}', ${index}, 'down')">Down</button>
                                <button class="btn" onclick="moveQueueItem('${villageId}', ${index}, 'bottom')">Bottom</button>
                                <button class="btn" style="background-color: var(--accent-secondary); color: var(--bg-primary); padding: 0.2rem 0.5rem;" onclick="removeQueueItem('${villageId}', ${index})">X</button>
                            </div>
                         </li>`;
            });
            queueHtml += '</ol>';

            detailsDiv.innerHTML = resourcesHtml + tabsHtml + fieldsContent + buildingsContent + trainingContent + newBuildContent + queueHtml;
            
            const tabElem = detailsDiv.querySelector(`#tab-${currentTab}`) || detailsDiv.querySelector('.tab');
            if (tabElem) {
                let tabName = tabElem.id.replace('tab-','');
                openTab({currentTarget: tabElem}, tabName);
            }
        }

        function queueUpgradeTask(villageId, location, gid, levelInputElementId) {
            const levelInput = document.getElementById(levelInputElementId);
            const level = levelInput.value;
            addBuildTask(villageId, location, gid, level);
        }

        function queueToMax(villageId, location, gid) {
            const villageQueue = FULL_STATE.build_queues[villageId] || [];
            const building = FULL_STATE.village_data[villageId].buildings.find(b => b.id == location);
            if (!building) return;

            const currentLevelInQueue = villageQueue.filter(q => q.location == location).reduce((maxLvl, q) => Math.max(maxLvl, q.level), building.level);
            const maxLevel = getMaxLevel(gid);
            
            if (currentLevelInQueue >= maxLevel) {
                alert('This building is already queued to its maximum level.');
                return;
            }

            const newTasks = [];
            for (let level = currentLevelInQueue + 1; level <= maxLevel; level++) {
                newTasks.push({ type: 'building', location: parseInt(location), gid: parseInt(gid), level: level });
            }
            
            const updatedQueue = villageQueue.concat(newTasks);
            socket.emit('update_build_queue', { villageId: villageId, queue: updatedQueue });
            alert(`Queued ${GID_MAP[gid]} from level ${currentLevelInQueue + 1} to ${maxLevel}.`);
        }
        
        function openTab(event, tabName) {
            document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            const tabContent = document.getElementById(tabName);
            if (tabContent) tabContent.style.display = 'block';
            if (event.currentTarget) event.currentTarget.classList.add('active');
            currentTab = tabName;
        }

        function saveTrainingSettings(villageId) {
            const settings = {};
            const trainingDataForVillage = FULL_STATE.training_data[villageId] || {};
            for (const buildingType in trainingDataForVillage) {
                const troopSelect = document.getElementById(`train-select-${villageId}-${buildingType}`);
                const durationInput = document.getElementById(`train-duration-${villageId}-${buildingType}`);
                if (troopSelect && durationInput) {
                    const troop_name = troopSelect.value;
                    const queue_duration_minutes = parseInt(durationInput.value, 10);
                    if (troop_name && queue_duration_minutes > 0) {
                        settings[buildingType] = { troop_name, queue_duration_minutes };
                    }
                }
            }
            socket.emit('update_training_queues', { villageId: villageId, settings: settings });
            alert('Training settings saved!');
        }

        document.getElementById('startBtn').onclick = () => socket.emit('start_bot');
        document.getElementById('stopBtn').onclick = () => socket.emit('stop_bot');
        document.getElementById('add-account-form').onsubmit = (e) => {
            e.preventDefault();
            socket.emit('add_account', {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                server_url: document.getElementById('server_url').value,
                use_dual_queue: document.getElementById('use_dual_queue').checked,
                use_hero_resources: document.getElementById('use_hero_resources').checked,
                proxy_ip: document.getElementById('proxy_ip').value,
                proxy_port: document.getElementById('proxy_port').value,
                proxy_user: document.getElementById('proxy_user').value,
                proxy_pass: document.getElementById('proxy_pass').value
            });
            e.target.reset();
        };

        function removeAccount(username) {
            if(confirm(`Are you sure you want to remove account: ${username}?`)) {
                socket.emit('remove_account', {username});
            }
        }
        
        function updateAccount(username, key, value) {
            socket.emit('update_account_setting', {username, key, value});
        }

        function removeQueueItem(villageId, index) {
           const currentQueue = FULL_STATE.build_queues[villageId] || [];
           currentQueue.splice(index, 1);
           socket.emit('update_build_queue', { villageId: villageId, queue: currentQueue });
        }

        function moveQueueItem(villageId, index, direction) {
            socket.emit('move_build_queue_item', {
                villageId: villageId,
                index: index,
                direction: direction
            });
        }

        function exportQueue(villageId) {
            const queue = FULL_STATE.build_queues[villageId] || [];
            const data = JSON.stringify(queue, null, 2);
            navigator.clipboard.writeText(data).then(()=>alert('Queue exported to clipboard.')); 
        }

        function importQueue(villageId) {
            const text = prompt('Paste build queue JSON:');
            if(!text) return;
            try {
                const parsed = JSON.parse(text);
                if(Array.isArray(parsed)) {
                    socket.emit('update_build_queue', { villageId:villageId, queue: parsed });
                } else {
                    alert('Invalid format. Please paste a valid JSON array.');
                }
            } catch(e) {
                alert('Failed to parse JSON: ' + e);
            }
        }

        // --- START: NEW importOffVillageQueue FUNCTION ---
        function importOffVillageQueue(villageId) {
            if (!confirm('This will replace the current build queue with the standard Off Village template. Are you sure?')) {
                return;
            }

            const offVillageQueue = [
                {"type": "building", "location": 26, "gid": 15, "level": 20},
                {"type": "building", "location": 39, "gid": 16, "level": 1},
                {"type": "building", "location": 19, "gid": 25, "level": 10},
                {"type": "resource_plan", "level": 5},
                {"type": "building", "location": 23, "gid": 10, "level": 5},
                {"type": "building", "location": 24, "gid": 11, "level": 5},
                {"type": "building", "location": 20, "gid": 19, "level": 3},
                {"type": "building", "location": 21, "gid": 22, "level": 10},
                {"type": "building", "location": 22, "gid": 24, "level": 10},
                {"type": "resource_plan", "level": 10},
                {"type": "building", "location": 25, "gid": 17, "level": 1},
                {"type": "building", "location": 27, "gid": 13, "level": 3},
                {"type": "building", "location": 28, "gid": 20, "level": 15},
                {"type": "building", "location": 29, "gid": 21, "level": 10},
                {"type": "building", "location": 30, "gid": 46, "level": 20},
                {"type": "building", "location": 40, "gid": 31, "level": 20},
                {"type": "building", "location": 19, "gid": 25, "level": 20},
                {"type": "building", "location": 20, "gid": 19, "level": 20},
                {"type": "building", "location": 21, "gid": 22, "level": 20},
                {"type": "building", "location": 22, "gid": 24, "level": 20},
                {"type": "building", "location": 23, "gid": 10, "level": 20},
                {"type": "building", "location": 24, "gid": 11, "level": 20},
                {"type": "building", "location": 25, "gid": 17, "level": 20},
                {"type": "building", "location": 27, "gid": 13, "level": 20},
                {"type": "building", "location": 28, "gid": 20, "level": 20},
                {"type": "building", "location": 29, "gid": 21, "level": 20},
                {"type": "building", "location": 39, "gid": 16, "level": 20},
                {"type": "building", "location": 31, "gid": 14, "level": 20},
                {"type": "building", "location": 32, "gid": 29, "level": 20},
                {"type": "building", "location": 33, "gid": 30, "level": 20},
                {"type": "building", "location": 34, "gid": 10, "level": 20},
                {"type": "building", "location": 35, "gid": 11, "level": 20},
                {"type": "building", "location": 36, "gid": 10, "level": 20},
                {"type": "building", "location": 37, "gid": 11, "level": 20}
            ];

            socket.emit('update_build_queue', { villageId: villageId, queue: offVillageQueue });
            alert('Standard Off Village build queue has been loaded.');
        }
        // --- END: NEW importOffVillageQueue FUNCTION ---

    </script>
</body>
</html>